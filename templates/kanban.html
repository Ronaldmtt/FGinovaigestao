{% extends "base.html" %}

{% block title %}Kanban - Sistema de Gerenciamento de Projetos{% endblock %}

{% block extra_css %}
<style>
.kanban-header {
    background: transparent;
    padding: 1.5rem 0;
    margin-bottom: 1.5rem;
}

.kanban-title {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.kanban-title i {
    font-size: 1.5rem;
}

.btn-transcription {
    background: var(--bs-secondary);
    color: white;
    border: none;
    padding: 0.625rem 1.25rem;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-transcription:hover {
    background: #5a6268;
    color: white;
}

.btn-new-task {
    background: #6366f1;
    color: white;
    border: none;
    padding: 0.625rem 1.25rem;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-new-task:hover {
    background: #5558e3;
    color: white;
}

.filters-section {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.filter-row {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.filter-group {
    flex: 1;
}

.filter-label {
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--bs-body-color);
}

.filter-select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--bs-border-color);
    border-radius: 6px;
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
    font-size: 0.875rem;
}

.filter-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.filter-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.filter-checkbox label {
    margin: 0;
    font-size: 0.875rem;
    cursor: pointer;
}

.filter-actions {
    display: flex;
    gap: 0.75rem;
}

.btn-filter {
    background: #6366f1;
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 6px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.btn-filter:hover {
    background: #5558e3;
    color: white;
}

.btn-clear-filters {
    background: var(--bs-secondary);
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 6px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.btn-clear-filters:hover {
    background: #5a6268;
    color: white;
}

.kanban-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.kanban-column-wrapper {
    display: flex;
    flex-direction: column;
}

.kanban-column-header {
    padding: 0.875rem 1.25rem;
    border-radius: 8px 8px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    font-size: 0.9375rem;
}

.kanban-column-header.pendente {
    background: #e5e7eb;
    color: #1f2937;
}

.kanban-column-header.em_andamento {
    background: #c7d2fe;
    color: #4338ca;
}

.kanban-column-header.concluida {
    background: #bbf7d0;
    color: #15803d;
}

[data-theme="dark"] .kanban-column-header.pendente {
    background: #374151;
    color: #e5e7eb;
}

[data-theme="dark"] .kanban-column-header.em_andamento {
    background: #4338ca;
    color: #e0e7ff;
}

[data-theme="dark"] .kanban-column-header.concluida {
    background: #166534;
    color: #d1fae5;
}

.column-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.column-badge {
    background: rgba(0,0,0,0.1);
    color: inherit;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

[data-theme="dark"] .column-badge {
    background: rgba(255,255,255,0.15);
}

.kanban-column {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 1rem;
    min-height: 500px;
}

.task-card {
    background: var(--bs-body-bg);
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.task-card:hover {
    border-color: #6366f1;
    box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
}

.task-card.disparada {
    border-left: 3px solid #ef4444;
}

.task-title {
    font-weight: 600;
    font-size: 0.9375rem;
    margin-bottom: 0.5rem;
    color: var(--bs-body-color);
    line-height: 1.4;
}

.task-project {
    font-size: 0.8125rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

[data-theme="dark"] .task-project {
    color: #9ca3af;
}

.task-meta {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    margin-top: 0.75rem;
}

.task-meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
}

.task-meta-item i {
    width: 14px;
    font-size: 0.75rem;
}

.task-meta-user {
    color: #6366f1;
}

.task-meta-date {
    color: #f59e0b;
}

.task-meta-dispatched {
    color: #ef4444;
    font-weight: 500;
}

.task-meta-completed {
    color: #10b981;
}
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="kanban-header">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="kanban-title">
            <i class="fas fa-columns"></i>
            Kanban
        </h1>
        <div class="d-flex gap-2">
            <button type="button" class="btn-transcription" data-bs-toggle="modal" data-bs-target="#transcriptionModal">
                <i class="fas fa-file-alt me-1"></i>Incluir Transcrição
            </button>
            <button type="button" class="btn-new-task" data-bs-toggle="modal" data-bs-target="#newTaskKanbanModal">
                <i class="fas fa-plus me-1"></i>Nova Tarefa
            </button>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="filters-section">
    <form method="GET">
        <div class="filter-row">
            <div class="filter-group">
                <div class="filter-label">Filtrar por Projeto</div>
                <select name="project_id" class="filter-select">
                    <option value="">Todos os projetos</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if current_filters.project_id == project.id %}selected{% endif %}>
                        {{ project.client.nome }} - {{ project.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Filtrar por Cliente</div>
                <select name="client_id" class="filter-select">
                    <option value="">Todos os clientes</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}" {% if current_filters.client_id == client.id %}selected{% endif %}>
                        {{ client.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <div class="filter-label">Filtrar por Usuário</div>
                <select name="user_id" class="filter-select">
                    <option value="">Todos os usuários</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}" {% if current_filters.user_id == user.id %}selected{% endif %}>
                        {{ user.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center">
            <div class="filter-checkbox">
                <input type="checkbox" name="my_tasks" value="1" id="myTasksCheck" 
                       {% if current_filters.my_tasks %}checked{% endif %}>
                <label for="myTasksCheck">Apenas minhas tarefas</label>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn-filter">
                    <i class="fas fa-filter"></i>
                    Filtrar
                </button>
                <a href="{{ url_for('kanban') }}" class="btn-clear-filters">
                    <i class="fas fa-times"></i>
                    Limpar Filtros
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Kanban Board -->
<div class="kanban-board">
    <!-- Coluna Pendente -->
    <div class="kanban-column-wrapper">
        <div class="kanban-column-header pendente">
            <div class="column-title">
                <i class="fas fa-clock"></i>
                Pendente
            </div>
            <span class="column-badge">{{ task_columns.pendente|length }}</span>
        </div>
        <div class="kanban-column" data-status="pendente">
            {% for task in task_columns.pendente %}
            <div class="task-card {% if task.disparada %}disparada{% endif %}" 
                 data-task-id="{{ task.id }}" 
                 draggable="true" 
                 onclick="editTask({{ task.id }})">
                <div class="task-title">{{ task.titulo }}</div>
                <div class="task-project">{{ task.project.client.nome }} - {{ task.project.nome }}</div>
                <div class="task-meta">
                    {% if task.assigned_user %}
                    <div class="task-meta-item task-meta-user">
                        <i class="fas fa-user"></i>
                        {{ task.assigned_user.full_name }}
                    </div>
                    {% endif %}
                    {% if task.data_conclusao %}
                    <div class="task-meta-item task-meta-date">
                        <i class="fas fa-calendar"></i>
                        {{ task.data_conclusao.strftime('%d/%m/%Y') }}
                    </div>
                    {% endif %}
                    {% if task.disparada and task.disparada_at %}
                    <div class="task-meta-item task-meta-dispatched">
                        <i class="fas fa-paper-plane"></i>
                        Disparada em {{ task.disparada_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Coluna Em Andamento -->
    <div class="kanban-column-wrapper">
        <div class="kanban-column-header em_andamento">
            <div class="column-title">
                <i class="fas fa-play"></i>
                Em Andamento
            </div>
            <span class="column-badge">{{ task_columns.em_andamento|length }}</span>
        </div>
        <div class="kanban-column" data-status="em_andamento">
            {% for task in task_columns.em_andamento %}
            <div class="task-card {% if task.disparada %}disparada{% endif %}" 
                 data-task-id="{{ task.id }}" 
                 draggable="true" 
                 onclick="editTask({{ task.id }})">
                <div class="task-title">{{ task.titulo }}</div>
                <div class="task-project">{{ task.project.client.nome }} - {{ task.project.nome }}</div>
                <div class="task-meta">
                    {% if task.assigned_user %}
                    <div class="task-meta-item task-meta-user">
                        <i class="fas fa-user"></i>
                        {{ task.assigned_user.full_name }}
                    </div>
                    {% endif %}
                    {% if task.data_conclusao %}
                    <div class="task-meta-item task-meta-date">
                        <i class="fas fa-calendar"></i>
                        {{ task.data_conclusao.strftime('%d/%m/%Y') }}
                    </div>
                    {% endif %}
                    {% if task.disparada and task.disparada_at %}
                    <div class="task-meta-item task-meta-dispatched">
                        <i class="fas fa-paper-plane"></i>
                        Disparada em {{ task.disparada_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Coluna Concluída -->
    <div class="kanban-column-wrapper">
        <div class="kanban-column-header concluida">
            <div class="column-title">
                <i class="fas fa-check-circle"></i>
                Concluída
            </div>
            <span class="column-badge">{{ task_columns.concluida|length }}</span>
        </div>
        <div class="kanban-column" data-status="concluida">
            {% for task in task_columns.concluida %}
            <div class="task-card {% if task.disparada %}disparada{% endif %}" 
                 data-task-id="{{ task.id }}" 
                 draggable="true" 
                 onclick="editTask({{ task.id }})">
                <div class="task-title">{{ task.titulo }}</div>
                <div class="task-project">{{ task.project.client.nome }} - {{ task.project.nome }}</div>
                <div class="task-meta">
                    {% if task.assigned_user %}
                    <div class="task-meta-item task-meta-user">
                        <i class="fas fa-user"></i>
                        {{ task.assigned_user.full_name }}
                    </div>
                    {% endif %}
                    {% if task.completed_at %}
                    <div class="task-meta-item task-meta-completed">
                        <i class="fas fa-check"></i>
                        {{ task.completed_at.strftime('%d/%m/%Y') }}
                    </div>
                    {% endif %}
                    {% if task.disparada and task.disparada_at %}
                    <div class="task-meta-item task-meta-dispatched">
                        <i class="fas fa-paper-plane"></i>
                        Disparada em {{ task.disparada_at.strftime('%d/%m/%Y %H:%M') }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Modal de Edição de Tarefa -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Editar Tarefa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTaskForm">
                <div class="modal-body">
                    <input type="hidden" id="editTaskId">
                    
                    <div class="mb-3">
                        <label for="editTaskTitulo" class="form-label">Título da Tarefa</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" id="editTaskTitulo" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskDescricao" class="form-label">Descrição</label>
                        <textarea class="form-control bg-dark text-light border-secondary" id="editTaskDescricao" rows="4"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskResponsavel" class="form-label">Responsável</label>
                        <select class="form-select bg-dark text-light border-secondary" id="editTaskResponsavel">
                            <option value="">Selecione um usuário</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskStatus" class="form-label">Status</label>
                        <select class="form-select bg-dark text-light border-secondary" id="editTaskStatus" required>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluida">Concluída</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskDataConclusao" class="form-label">Data de Conclusão</label>
                        <input type="date" class="form-control bg-dark text-light border-secondary" id="editTaskDataConclusao">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Lista de To-Do's</label>
                        <div id="todosList" class="border border-secondary rounded p-2 bg-dark" style="max-height: 200px; overflow-y: auto;">
                            <!-- To-do's serão carregados aqui -->
                        </div>
                        <div class="d-flex mt-2">
                            <input type="text" class="form-control bg-dark text-light border-secondary" id="newTodoText" placeholder="Adicionar novo to-do..." maxlength="300">
                            <button type="button" class="btn btn-outline-primary ms-2" onclick="addTodo()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-danger me-auto" onclick="deleteTask()">
                        <i class="fas fa-trash"></i> Deletar Tarefa
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Nova Tarefa -->
<div class="modal fade" id="newTaskKanbanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Nova Tarefa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('new_manual_task') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Título da Tarefa</label>
                        <input type="text" class="form-control bg-dark text-light border-secondary" name="titulo" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control bg-dark text-light border-secondary" name="descricao" rows="4"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Projeto</label>
                        <select class="form-select bg-dark text-light border-secondary" name="project_id" required>
                            <option value="">Selecione um projeto</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.client.nome }} - {{ project.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Responsável</label>
                        <select class="form-select bg-dark text-light border-secondary" name="assigned_user_id">
                            <option value="">Selecione um usuário</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Data de Conclusão</label>
                        <input type="date" class="form-control bg-dark text-light border-secondary" name="data_conclusao">
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Criar Tarefa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Transcrição -->
<div class="modal fade" id="transcriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Incluir Transcrição
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="transcriptionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="transcriptionProject" class="form-label">Selecionar Projeto</label>
                        <select class="form-select bg-dark text-light border-secondary" id="transcriptionProject" required>
                            <option value="">Selecione um projeto</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.client.nome }} - {{ project.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transcriptionText" class="form-label">Transcrição</label>
                        <textarea class="form-control bg-dark text-light border-secondary" id="transcriptionText" rows="8" 
                                  placeholder="Cole aqui a transcrição da reunião ou discussão do projeto..." required></textarea>
                        <div class="form-text text-light-emphasis">A IA analisará esta transcrição e gerará tarefas automaticamente para o projeto selecionado.</div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-magic me-1"></i>Gerar Tarefas
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Variáveis globais para todos
let currentTodos = [];

// Função para editar tarefa
function editTask(taskId) {
    fetch(`/api/tasks/${taskId}`)
        .then(response => response.json())
        .then(task => {
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitulo').value = task.titulo;
            document.getElementById('editTaskDescricao').value = task.descricao || '';
            document.getElementById('editTaskResponsavel').value = task.assigned_user_id || '';
            document.getElementById('editTaskStatus').value = task.status || 'pendente';
            document.getElementById('editTaskDataConclusao').value = task.data_conclusao || '';
            
            loadTodos(task.todos || []);
            
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao carregar dados da tarefa:', error);
            alert('Erro ao carregar dados da tarefa');
        });
}

// Gerenciamento de To-Dos
function loadTodos(todos) {
    currentTodos = todos;
    renderTodos();
}

function renderTodos() {
    const todosList = document.getElementById('todosList');
    
    if (currentTodos.length === 0) {
        todosList.innerHTML = '<p class="text-muted mb-0 p-2">Nenhum to-do adicionado ainda.</p>';
        return;
    }
    
    todosList.innerHTML = currentTodos.map((todo, index) => `
        <div class="d-flex align-items-center gap-2 p-2 border-bottom border-secondary">
            <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                   onchange="toggleTodo(${index})" 
                   class="form-check-input">
            <span class="${todo.completed ? 'text-decoration-line-through text-muted' : ''}" 
                  style="flex: 1;">${todo.texto}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteTodo(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

function addTodo() {
    const newTodoText = document.getElementById('newTodoText').value.trim();
    if (!newTodoText) return;
    
    currentTodos.push({
        texto: newTodoText,
        completed: false
    });
    
    document.getElementById('newTodoText').value = '';
    renderTodos();
}

function toggleTodo(index) {
    currentTodos[index].completed = !currentTodos[index].completed;
    renderTodos();
}

function deleteTodo(index) {
    currentTodos.splice(index, 1);
    renderTodos();
}

function getCurrentTodos() {
    return currentTodos;
}

// Salvar alterações da tarefa
document.getElementById('editTaskForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('editTaskId').value;
    const formData = {
        titulo: document.getElementById('editTaskTitulo').value,
        descricao: document.getElementById('editTaskDescricao').value,
        assigned_user_id: document.getElementById('editTaskResponsavel').value || null,
        status: document.getElementById('editTaskStatus').value,
        data_conclusao: document.getElementById('editTaskDataConclusao').value || null,
        todos: getCurrentTodos()
    };
    
    fetch(`/api/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao atualizar tarefa');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao atualizar tarefa');
    });
});

// Deletar tarefa
function deleteTask() {
    if (!confirm('Tem certeza que deseja deletar esta tarefa?')) return;
    
    const taskId = document.getElementById('editTaskId').value;
    
    fetch(`/api/tasks/${taskId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Erro ao deletar tarefa');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao deletar tarefa');
    });
}

// Form de transcrição
document.getElementById('transcriptionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const projectId = document.getElementById('transcriptionProject').value;
    const transcriptionText = document.getElementById('transcriptionText').value;
    
    fetch('/transcription_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            project_id: projectId,
            transcricao: transcriptionText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Erro ao processar transcrição');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar transcrição');
    });
});

// Drag and Drop
let draggedTask = null;

document.querySelectorAll('.task-card').forEach(card => {
    card.addEventListener('dragstart', function(e) {
        draggedTask = this;
        e.dataTransfer.effectAllowed = 'move';
        this.style.opacity = '0.5';
    });
    
    card.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
    });
});

document.querySelectorAll('.kanban-column').forEach(column => {
    column.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    });
    
    column.addEventListener('drop', function(e) {
        e.preventDefault();
        
        if (draggedTask) {
            const taskId = draggedTask.dataset.taskId;
            const newStatus = this.dataset.status;
            
            fetch(`/api/tasks/${taskId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    });
});
</script>
{% endblock %}
