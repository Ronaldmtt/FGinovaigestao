{% extends "base.html" %}

{% block title %}Kanban - Sistema de Gerenciamento de Projetos{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-columns me-2"></i>Kanban</h2>
            <div>
                <button type="button" class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#transcriptionModal">
                    <i class="fas fa-arrow-down me-1"></i>Incluir Transcrição
                </button>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskKanbanModal">
                    <i class="fas fa-plus me-1"></i>Nova Tarefa
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="row mb-3">
    <div class="col-12">
        <form method="GET" class="d-flex align-items-center gap-3 flex-wrap">
            <div style="min-width: 200px;">
                <select name="project_id" class="form-select kanban-filter-select">
                    <option value="">Filtrar por Projeto</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" {% if current_filters.project_id == project.id %}selected{% endif %}>
                        {{ project.client.nome }} - {{ project.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="min-width: 200px;">
                <select name="client_id" class="form-select kanban-filter-select">
                    <option value="">Filtrar por Cliente</option>
                    {% for client in clients %}
                    <option value="{{ client.id }}" {% if current_filters.client_id == client.id %}selected{% endif %}>
                        {{ client.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="min-width: 200px;">
                <select name="user_id" class="form-select kanban-filter-select">
                    <option value="">Filtrar por Usuário</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}" {% if current_filters.user_id == user.id %}selected{% endif %}>
                        {{ user.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="my_tasks" value="1" 
                       {% if current_filters.my_tasks %}checked{% endif %} id="myTasksCheck">
                <label class="form-check-label" for="myTasksCheck">
                    Apenas minhas tarefas
                </label>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-filter me-1"></i>Filtrar
            </button>
            
            <a href="{{ url_for('kanban') }}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i>Limpar Filtros
            </a>
        </form>
    </div>
</div>

<!-- Kanban Board -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="kanban-column-container">
            <div class="kanban-column-header kanban-header-pendente">
                <div class="d-flex align-items-center">
                    <div class="kanban-icon-circle" style="background-color: #6c757d; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                        <i class="fas fa-clock" style="color: white; font-size: 14px;"></i>
                    </div>
                    <h6 class="mb-0 me-2" style="font-weight: 600;">Pendente</h6>
                    <span class="badge rounded-pill kanban-badge-pendente">{{ task_columns.pendente|length }}</span>
                </div>
            </div>
            <div class="kanban-column" data-status="pendente" style="min-height: 400px;">
                {% for task in task_columns.pendente %}
                <div class="task-card-modern card mb-3" data-task-id="{{ task.id }}" draggable="true" onclick="editTask({{ task.id }})" style="cursor: pointer; border-left: 4px solid #6c757d; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-2" style="font-weight: 600; font-size: 14px;">
                            {% if task.disparada %}<i class="fas fa-paper-plane text-danger me-1" title="Tarefa disparada"></i>{% endif %}
                            {{ task.titulo }}
                        </h6>
                        <small class="d-block mb-1" style="color: #6c757d; font-size: 12px;">{{ task.project.client.nome }} - {{ task.project.nome }}</small>
                        {% if task.assigned_user %}
                        <small class="d-block mb-1" style="color: #0d6efd; font-size: 12px;">
                            <i class="fas fa-user me-1"></i>{{ task.assigned_user.full_name }}
                        </small>
                        {% endif %}
                        {% if task.data_conclusao %}
                        <small class="d-block" style="color: #ffc107; font-size: 12px;">
                            <i class="fas fa-calendar me-1"></i>{{ task.data_conclusao.strftime('%d/%m/%Y') }}
                        </small>
                        {% endif %}
                        {% if task.disparada and task.disparada_at %}
                        <small class="d-block text-danger" style="font-size: 12px;">
                            <i class="fas fa-paper-plane me-1"></i>Disparada em {{ task.disparada_at.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="kanban-column-container">
            <div class="kanban-column-header kanban-header-andamento">
                <div class="d-flex align-items-center">
                    <div class="kanban-icon-circle" style="background-color: #6554c0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                        <i class="fas fa-play" style="color: white; font-size: 12px;"></i>
                    </div>
                    <h6 class="mb-0 me-2" style="font-weight: 600;">Em Andamento</h6>
                    <span class="badge rounded-pill kanban-badge-andamento">{{ task_columns.em_andamento|length }}</span>
                </div>
            </div>
            <div class="kanban-column" data-status="em_andamento" style="min-height: 400px;">
                {% for task in task_columns.em_andamento %}
                <div class="task-card-modern card mb-3" data-task-id="{{ task.id }}" draggable="true" onclick="editTask({{ task.id }})" style="cursor: pointer; border-left: 4px solid #6554c0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-2" style="font-weight: 600; font-size: 14px;">
                            {% if task.disparada %}<i class="fas fa-paper-plane text-danger me-1" title="Tarefa disparada"></i>{% endif %}
                            {{ task.titulo }}
                        </h6>
                        <small class="d-block mb-1" style="color: #6c757d; font-size: 12px;">{{ task.project.client.nome }} - {{ task.project.nome }}</small>
                        {% if task.assigned_user %}
                        <small class="d-block mb-1" style="color: #0d6efd; font-size: 12px;">
                            <i class="fas fa-user me-1"></i>{{ task.assigned_user.full_name }}
                        </small>
                        {% endif %}
                        {% if task.data_conclusao %}
                        <small class="d-block" style="color: #ffc107; font-size: 12px;">
                            <i class="fas fa-calendar me-1"></i>{{ task.data_conclusao.strftime('%d/%m/%Y') }}
                        </small>
                        {% endif %}
                        {% if task.disparada and task.disparada_at %}
                        <small class="d-block text-danger" style="font-size: 12px;">
                            <i class="fas fa-paper-plane me-1"></i>Disparada em {{ task.disparada_at.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="kanban-column-container">
            <div class="kanban-column-header kanban-header-concluida">
                <div class="d-flex align-items-center">
                    <div class="kanban-icon-circle" style="background-color: #00a86b; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                        <i class="fas fa-check" style="color: white; font-size: 14px;"></i>
                    </div>
                    <h6 class="mb-0 me-2" style="font-weight: 600;">Concluída</h6>
                    <span class="badge rounded-pill kanban-badge-concluida">{{ task_columns.concluida|length }}</span>
                </div>
            </div>
            <div class="kanban-column" data-status="concluida" style="min-height: 400px;">
                {% for task in task_columns.concluida %}
                <div class="task-card-modern card mb-3" data-task-id="{{ task.id }}" draggable="true" onclick="editTask({{ task.id }})" style="cursor: pointer; border-left: 4px solid #00a86b; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-2" style="font-weight: 600; font-size: 14px;">
                            {% if task.disparada %}<i class="fas fa-paper-plane text-danger me-1" title="Tarefa disparada"></i>{% endif %}
                            {{ task.titulo }}
                        </h6>
                        <small class="d-block mb-1" style="color: #6c757d; font-size: 12px;">{{ task.project.client.nome }} - {{ task.project.nome }}</small>
                        {% if task.assigned_user %}
                        <small class="d-block mb-1" style="color: #0d6efd; font-size: 12px;">
                            <i class="fas fa-user me-1"></i>{{ task.assigned_user.full_name }}
                        </small>
                        {% endif %}
                        {% if task.completed_at %}
                        <small class="d-block" style="color: #00a86b; font-size: 12px;">
                            <i class="fas fa-check me-1"></i>{{ task.completed_at.strftime('%d/%m/%Y') }}
                        </small>
                        {% endif %}
                        {% if task.disparada and task.disparada_at %}
                        <small class="d-block text-danger" style="font-size: 12px;">
                            <i class="fas fa-paper-plane me-1"></i>Disparada em {{ task.disparada_at.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição de Tarefa -->
<div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTaskModalLabel">Editar Tarefa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTaskForm">
                <div class="modal-body">
                    <input type="hidden" id="editTaskId">
                    
                    <div class="mb-3">
                        <label for="editTaskTitulo" class="form-label">Título da Tarefa</label>
                        <input type="text" class="form-control" id="editTaskTitulo" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskDescricao" class="form-label">Descrição</label>
                        <textarea class="form-control" id="editTaskDescricao" rows="4"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskResponsavel" class="form-label">Responsável</label>
                        <select class="form-select" id="editTaskResponsavel">
                            <option value="">Selecione um usuário</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskStatus" class="form-label">Status</label>
                        <select class="form-select" id="editTaskStatus" required>
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluida">Concluída</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editTaskDataConclusao" class="form-label">Data de Conclusão</label>
                        <input type="date" class="form-control" id="editTaskDataConclusao">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Lista de To-Do's</label>
                        <div id="todosList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <!-- To-do's serão carregados aqui -->
                        </div>
                        <div class="d-flex mt-2">
                            <input type="text" class="form-control" id="newTodoText" placeholder="Adicionar novo to-do..." maxlength="300">
                            <button type="button" class="btn btn-outline-primary ms-2" onclick="addTodo()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" onclick="deleteTask()">
                        <i class="fas fa-trash"></i> Deletar Tarefa
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Transcrição -->
<div class="modal fade" id="transcriptionModal" tabindex="-1" aria-labelledby="transcriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transcriptionModalLabel">
                    <i class="fas fa-microphone me-2"></i>Incluir Transcrição
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="transcriptionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="transcriptionProject" class="form-label">Selecionar Projeto</label>
                        <select class="form-select" id="transcriptionProject" required>
                            <option value="">Selecione um projeto</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.client.nome }} - {{ project.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transcriptionText" class="form-label">Transcrição</label>
                        <textarea class="form-control" id="transcriptionText" rows="8" 
                                  placeholder="Cole aqui a transcrição da reunião ou discussão do projeto..." required></textarea>
                        <div class="form-text">A IA analisará esta transcrição e gerará tarefas automaticamente para o projeto selecionado.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-magic me-1"></i>Gerar Tarefas
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Função para editar tarefa
function editTask(taskId) {
    fetch(`/api/tasks/${taskId}`)
        .then(response => response.json())
        .then(task => {
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskTitulo').value = task.titulo;
            document.getElementById('editTaskDescricao').value = task.descricao || '';
            document.getElementById('editTaskResponsavel').value = task.assigned_user_id || '';
            document.getElementById('editTaskStatus').value = task.status || 'pendente';
            document.getElementById('editTaskDataConclusao').value = task.data_conclusao || '';
            
            // Carregar to-do's
            loadTodos(task.todos || []);
            
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Erro ao carregar dados da tarefa:', error);
            alert('Erro ao carregar dados da tarefa');
        });
}

// Função para atualizar card em tempo real
function updateTaskCard(taskData) {
    const taskCard = document.querySelector(`[data-task-id="${taskData.id}"]`);
    if (!taskCard) return;
    
    const cardBody = taskCard.querySelector('.card-body');
    
    // Atualizar o conteúdo do card
    let newContent = `
        <div class="d-flex justify-content-between align-items-start">
            <h6 class="card-title mb-1">${taskData.titulo}</h6>
            <button class="btn btn-sm btn-outline-primary" onclick="editTask(${taskData.id})" title="Editar tarefa">
                <i class="fas fa-edit"></i>
            </button>
        </div>
        <small class="text-muted d-block">${taskData.project_client_name} - ${taskData.project_name}</small>
    `;
    
    // Adicionar responsável se existir
    if (taskData.assigned_user_name) {
        newContent += `
        <small class="text-info d-block">
            <i class="fas fa-user me-1"></i>${taskData.assigned_user_name}
        </small>
        `;
    }
    
    // Adicionar data de conclusão ou completed_at dependendo do status
    if (taskData.status === 'concluida' && taskData.completed_at) {
        newContent += `
        <small class="text-success d-block">
            <i class="fas fa-check-circle me-1"></i>${taskData.completed_at}
        </small>
        `;
    } else if (taskData.data_conclusao) {
        newContent += `
        <small class="text-warning d-block">
            <i class="fas fa-calendar me-1"></i>${taskData.data_conclusao}
        </small>
        `;
    }
    
    cardBody.innerHTML = newContent;
}

// Salvar alterações da tarefa
document.getElementById('editTaskForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const taskId = document.getElementById('editTaskId').value;
    const formData = {
        titulo: document.getElementById('editTaskTitulo').value,
        descricao: document.getElementById('editTaskDescricao').value,
        assigned_user_id: document.getElementById('editTaskResponsavel').value || null,
        status: document.getElementById('editTaskStatus').value,
        data_conclusao: document.getElementById('editTaskDataConclusao').value || null,
        todos: getCurrentTodos()
    };
    
    fetch(`/api/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
            modal.hide();
            
            // Atualizar card em tempo real
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            const currentColumn = taskCard.closest('.kanban-column');
            const targetColumn = document.querySelector(`[data-status="${data.task.status}"]`);
            
            // Se mudou de coluna, mover o card
            if (currentColumn.dataset.status !== data.task.status) {
                targetColumn.appendChild(taskCard);
                updateColumnCounts();
            }
            
            // Atualizar o conteúdo do card
            updateTaskCard(data.task);
            
        } else {
            alert('Erro ao salvar alterações: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro ao salvar tarefa:', error);
        alert('Erro ao salvar alterações');
    });
});

// Funções para gerenciar to-do's
function loadTodos(todos) {
    const todosList = document.getElementById('todosList');
    todosList.innerHTML = '';
    
    todos.forEach(todo => {
        const todoDiv = document.createElement('div');
        todoDiv.className = 'd-flex align-items-center mb-2';
        todoDiv.innerHTML = `
            <input type="checkbox" class="form-check-input me-2" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(this, ${todo.id})">
            <span class="todo-text ${todo.completed ? 'text-decoration-line-through text-muted' : ''}" 
                  style="flex-grow: 1; cursor: pointer;" 
                  data-todo-id="${todo.id}"
                  onclick="enableTodoEdit(this)">${todo.texto}</span>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeTodo(this, ${todo.id})">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        todoDiv.dataset.todoId = todo.id;
        todoDiv.dataset.todoText = todo.texto;
        todoDiv.dataset.todoCompleted = todo.completed;
        todosList.appendChild(todoDiv);
    });
}

// Função para habilitar edição inline do to-do (estilo Trello)
function enableTodoEdit(span) {
    if (span.querySelector('input')) return; // Já está editando
    
    const todoId = span.dataset.todoId;
    const currentText = span.textContent;
    
    // Criar input de edição
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control form-control-sm';
    input.value = currentText;
    input.style.flexGrow = '1';
    
    // Substituir span por input
    span.textContent = '';
    span.appendChild(input);
    input.focus();
    input.select();
    
    // Função para salvar
    const saveTodo = async () => {
        const newText = input.value.trim();
        
        if (!newText) {
            input.value = currentText; // Restaurar texto original se vazio
            return;
        }
        
        if (newText === currentText) {
            // Sem mudanças, apenas restaurar
            span.textContent = currentText;
            return;
        }
        
        // Salvar no backend
        try {
            const response = await fetch(`/api/todos/${todoId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ texto: newText })
            });
            
            const data = await response.json();
            
            if (data.success) {
                span.textContent = newText;
                // Atualizar dataset
                const todoDiv = span.closest('[data-todo-id]');
                if (todoDiv) {
                    todoDiv.dataset.todoText = newText;
                }
            } else {
                alert('Erro ao atualizar: ' + data.message);
                span.textContent = currentText;
            }
        } catch (error) {
            console.error('Erro ao atualizar to-do:', error);
            alert('Erro ao atualizar to-do');
            span.textContent = currentText;
        }
    };
    
    // Salvar ao pressionar Enter ou perder foco
    input.addEventListener('blur', saveTodo);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            input.blur();
        }
    });
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            span.textContent = currentText; // Cancelar edição
        }
    });
}

function addTodo() {
    const newTodoText = document.getElementById('newTodoText');
    const text = newTodoText.value.trim();
    
    if (text) {
        const todosList = document.getElementById('todosList');
        const todoDiv = document.createElement('div');
        todoDiv.className = 'd-flex align-items-center mb-2';
        todoDiv.innerHTML = `
            <input type="checkbox" class="form-check-input me-2" onchange="toggleTodo(this)">
            <span class="todo-text" style="flex-grow: 1; cursor: pointer;" data-todo-id="new-${Date.now()}" onclick="enableTodoEdit(this)">${text}</span>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="removeTodo(this)">
                <i class="fas fa-trash-alt"></i>
            </button>
        `;
        todoDiv.dataset.todoId = 'new-' + Date.now();
        todoDiv.dataset.todoText = text;
        todoDiv.dataset.todoCompleted = 'false';
        
        todosList.appendChild(todoDiv);
        newTodoText.value = '';
    }
}

function toggleTodo(checkbox, todoId = null) {
    const todoDiv = checkbox.closest('div');
    const span = todoDiv.querySelector('span');
    const isCompleted = checkbox.checked;
    
    if (isCompleted) {
        span.classList.add('text-decoration-line-through', 'text-muted');
    } else {
        span.classList.remove('text-decoration-line-through', 'text-muted');
    }
    
    todoDiv.dataset.todoCompleted = isCompleted.toString();
}

function removeTodo(button, todoId = null) {
    const todoDiv = button.closest('div');
    todoDiv.remove();
}

function getCurrentTodos() {
    const todosList = document.getElementById('todosList');
    const todoDivs = todosList.querySelectorAll('[data-todo-id]');
    const todos = [];
    
    todoDivs.forEach(todoDiv => {
        todos.push({
            id: todoDiv.dataset.todoId.startsWith('new-') ? null : parseInt(todoDiv.dataset.todoId),
            texto: todoDiv.dataset.todoText,
            completed: todoDiv.dataset.todoCompleted === 'true'
        });
    });
    
    return todos;
}

function updateColumnCounts() {
    // Atualizar contadores das colunas
    const columns = document.querySelectorAll('.kanban-column');
    columns.forEach(column => {
        const count = column.querySelectorAll('.task-card').length;
        const badge = column.parentElement.querySelector('.badge');
        if (badge) {
            badge.textContent = count;
        }
    });
}

// Função para deletar tarefa
function deleteTask() {
    const taskId = document.getElementById('editTaskId').value;
    const taskTitle = document.getElementById('editTaskTitulo').value;
    
    if (confirm(`Tem certeza que deseja deletar a tarefa "${taskTitle}"? Esta ação não pode ser desfeita.`)) {
        fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
                modal.hide();
                
                // Remover o card da interface
                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskCard) {
                    taskCard.remove();
                    updateColumnCounts();
                }
                
                alert('Tarefa deletada com sucesso!');
            } else {
                alert('Erro ao deletar tarefa: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao deletar tarefa:', error);
            alert('Erro ao deletar tarefa');
        });
    }
}

// Função para processar transcrição
document.getElementById('transcriptionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const projectId = document.getElementById('transcriptionProject').value;
    const transcriptionText = document.getElementById('transcriptionText').value;
    
    if (!projectId || !transcriptionText.trim()) {
        alert('Por favor, selecione um projeto e insira uma transcrição.');
        return;
    }
    
    const submitButton = this.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processando...';
    submitButton.disabled = true;
    
    fetch('/kanban/transcription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            project_id: projectId,
            transcription: transcriptionText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('transcriptionModal'));
            modal.hide();
            
            // Limpar formulário
            document.getElementById('transcriptionProject').value = '';
            document.getElementById('transcriptionText').value = '';
            
            alert(`${data.tasks_created} tarefas foram geradas com sucesso!`);
            location.reload(); // Recarregar para mostrar as novas tarefas
        } else {
            alert('Erro ao processar transcrição: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro ao processar transcrição:', error);
        alert('Erro ao processar transcrição. Tente novamente.');
    })
    .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
});

// Permitir adicionar to-do com Enter
document.addEventListener('keypress', function(e) {
    if (e.target.id === 'newTodoText' && e.key === 'Enter') {
        addTodo();
    }
});

// Função para disparar tarefa
function dispatchTask(taskId) {
    if (!confirm('Deseja disparar/cancelar o disparo desta tarefa?')) {
        return;
    }
    
    fetch(`/api/tasks/${taskId}/dispatch`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const button = document.getElementById(`dispatch-btn-${taskId}`);
            const card = document.querySelector(`[data-task-id="${taskId}"]`);
            
            if (data.disparada) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-danger');
                button.title = 'Cancelar disparo';
                card.classList.add('border-danger');
                alert('Tarefa disparada com sucesso!');
            } else {
                button.classList.remove('btn-danger');
                button.classList.add('btn-outline-secondary');
                button.title = 'Disparar tarefa';
                card.classList.remove('border-danger');
                alert('Disparo cancelado com sucesso!');
            }
            
            location.reload();
        } else {
            alert('Erro ao disparar tarefa: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro ao disparar tarefa:', error);
        alert('Erro ao disparar tarefa. Tente novamente.');
    });
}

// Função para disparar tarefas filtradas
function dispatchFilteredTasks() {
    const projectId = document.querySelector('select[name="project_id"]').value;
    const clientId = document.querySelector('select[name="client_id"]').value;
    const userId = document.querySelector('select[name="user_id"]').value;
    const myTasks = document.querySelector('input[name="my_tasks"]').checked;
    
    let confirmMessage = 'Deseja enviar emails de resumo de tarefas ';
    if (userId) {
        const userName = document.querySelector('select[name="user_id"] option:checked').text;
        confirmMessage += `para ${userName}?`;
    } else {
        confirmMessage += 'para todos os usuários com tarefas atribuídas?';
    }
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    fetch('/api/disparar-tarefas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            project_id: projectId || null,
            client_id: clientId || null,
            user_id: userId || null,
            my_tasks: myTasks
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`✓ ${data.message}\n\nUsuários notificados:\n${data.usuarios.join('\n')}`);
        } else {
            alert('⚠ ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro ao disparar tarefas:', error);
        alert('Erro ao enviar emails. Tente novamente.');
    });
}

// ============================================
// DRAG AND DROP FUNCTIONALITY
// ============================================

let draggedElement = null;

// Inicializar drag and drop quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
});

function initializeDragAndDrop() {
    const taskCards = document.querySelectorAll('.task-card-modern');
    const columns = document.querySelectorAll('.kanban-column');
    
    // Adicionar event listeners para cada card
    taskCards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    // Adicionar event listeners para cada coluna
    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
        column.addEventListener('dragleave', handleDragLeave);
        column.addEventListener('dragenter', handleDragEnter);
    });
}

function handleDragStart(e) {
    // Verificar se o elemento é válido
    if (!e.target || !e.target.classList.contains('task-card-modern')) {
        console.error('Erro: card não é um HTMLElement válido');
        return;
    }
    
    draggedElement = e.target;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', e.target.innerHTML);
    
    // Prevenir que o onclick seja acionado
    setTimeout(() => {
        e.target.style.pointerEvents = 'none';
    }, 0);
}

function handleDragEnd(e) {
    if (!e.target) return;
    
    e.target.classList.remove('dragging');
    e.target.style.pointerEvents = 'auto';
    
    // Remover visual de drag-over de todas as colunas
    document.querySelectorAll('.kanban-column').forEach(column => {
        column.classList.remove('drag-over');
    });
    
    draggedElement = null;
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (!e.currentTarget.classList.contains('kanban-column')) return;
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    if (!e.currentTarget.classList.contains('kanban-column')) return;
    
    // Verificar se realmente saiu da coluna
    const rect = e.currentTarget.getBoundingClientRect();
    if (e.clientX <= rect.left || e.clientX >= rect.right || 
        e.clientY <= rect.top || e.clientY >= rect.bottom) {
        e.currentTarget.classList.remove('drag-over');
    }
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    if (!draggedElement) {
        console.error('Erro: nenhum elemento sendo arrastado');
        return false;
    }
    
    const targetColumn = e.currentTarget;
    targetColumn.classList.remove('drag-over');
    
    const newStatus = targetColumn.dataset.status;
    const taskId = draggedElement.dataset.taskId;
    const currentStatus = draggedElement.closest('.kanban-column').dataset.status;
    
    // Verificar se mudou de coluna
    if (newStatus === currentStatus) {
        return false;
    }
    
    // Atualizar visualmente primeiro
    targetColumn.appendChild(draggedElement);
    
    // Atualizar a cor da borda lateral do card
    draggedElement.style.borderLeftColor = getBorderColorForStatus(newStatus);
    
    // Atualizar no backend
    updateTaskStatus(taskId, newStatus);
    
    // Atualizar contadores
    updateColumnCounters();
    
    return false;
}

function getBorderColorForStatus(status) {
    const colors = {
        'pendente': '#6c757d',
        'em_andamento': '#6554c0',
        'concluida': '#00a86b'
    };
    return colors[status] || '#6c757d';
}

function updateTaskStatus(taskId, newStatus) {
    fetch(`/api/tasks/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Erro ao atualizar status da tarefa:', data.message);
            alert('Erro ao atualizar status da tarefa. Recarregando a página...');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Erro ao atualizar tarefa:', error);
        alert('Erro ao atualizar tarefa. Recarregando a página...');
        location.reload();
    });
}

function updateColumnCounters() {
    const columns = document.querySelectorAll('.kanban-column');
    
    columns.forEach(column => {
        const status = column.dataset.status;
        const count = column.querySelectorAll('.task-card-modern').length;
        
        // Encontrar o badge correspondente
        let badgeClass = '';
        if (status === 'pendente') badgeClass = 'kanban-badge-pendente';
        else if (status === 'em_andamento') badgeClass = 'kanban-badge-andamento';
        else if (status === 'concluida') badgeClass = 'kanban-badge-concluida';
        
        const badge = document.querySelector(`.${badgeClass}`);
        if (badge) {
            badge.textContent = count;
        }
    });
}
</script>

<!-- Modal para Nova Tarefa no Kanban -->
<div class="modal fade" id="newTaskKanbanModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('new_task_kanban') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Tarefa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Título da Tarefa</label>
                            <input type="text" class="form-control" name="titulo" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Projeto</label>
                            <select class="form-select" name="project_id" required>
                                <option value="">Selecione um projeto</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" {% if current_filters.project_id == project.id %}selected{% endif %}>
                                    {{ project.client.nome }} - {{ project.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Usuário Responsável</label>
                            <select class="form-select" name="assigned_user_id">
                                <option value="">Selecione um usuário</option>
                                {% for user in all_users %}
                                <option value="{{ user.id }}">{{ user.full_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data de Conclusão</label>
                            <input type="date" class="form-control" name="data_conclusao">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" required>
                            <option value="pendente" selected>Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluida">Concluída</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" name="descricao" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Tarefa</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Estilos customizados para Kanban moderno */
.kanban-column-header {
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 16px;
}

/* Cabeçalhos das colunas - Tema Escuro */
[data-theme="dark"] .kanban-header-pendente,
body:not([data-theme]) .kanban-header-pendente {
    background-color: rgba(169, 169, 169, 0.15);
    color: #e2e8f0;
}

[data-theme="dark"] .kanban-header-andamento,
body:not([data-theme]) .kanban-header-andamento {
    background-color: rgba(101, 84, 192, 0.15);
    color: #e2e8f0;
}

[data-theme="dark"] .kanban-header-concluida,
body:not([data-theme]) .kanban-header-concluida {
    background-color: rgba(0, 168, 107, 0.15);
    color: #e2e8f0;
}

/* Cabeçalhos das colunas - Tema Claro */
[data-theme="light"] .kanban-header-pendente {
    background-color: rgba(169, 169, 169, 0.1);
    color: #2d3748;
}

[data-theme="light"] .kanban-header-andamento {
    background-color: rgba(101, 84, 192, 0.1);
    color: #2d3748;
}

[data-theme="light"] .kanban-header-concluida {
    background-color: rgba(0, 168, 107, 0.1);
    color: #2d3748;
}

/* Badges - Tema Escuro */
[data-theme="dark"] .kanban-badge-pendente,
[data-theme="dark"] .kanban-badge-andamento,
[data-theme="dark"] .kanban-badge-concluida,
body:not([data-theme]) .kanban-badge-pendente,
body:not([data-theme]) .kanban-badge-andamento,
body:not([data-theme]) .kanban-badge-concluida {
    background-color: rgba(255, 255, 255, 0.15);
    color: #e2e8f0;
    padding: 4px 12px;
}

/* Badges - Tema Claro */
[data-theme="light"] .kanban-badge-pendente,
[data-theme="light"] .kanban-badge-andamento,
[data-theme="light"] .kanban-badge-concluida {
    background-color: rgba(0, 0, 0, 0.08);
    color: #2d3748;
    padding: 4px 12px;
}

/* Cards - Tema Escuro */
[data-theme="dark"] .task-card-modern,
body:not([data-theme]) .task-card-modern {
    background-color: #2d3748;
    border-color: #4a5568;
}

[data-theme="dark"] .task-card-modern .card-body,
body:not([data-theme]) .task-card-modern .card-body {
    color: #e2e8f0;
}

/* Cards - Tema Claro */
[data-theme="light"] .task-card-modern {
    background-color: #ffffff;
    border-color: #e2e8f0;
}

[data-theme="light"] .task-card-modern .card-body {
    color: #2d3748;
}

/* Filtros - Tema Escuro */
[data-theme="dark"] .kanban-filter-select,
body:not([data-theme]) .kanban-filter-select {
    background-color: #2d3748;
    color: #e2e8f0;
    border-color: #4a5568;
}

[data-theme="dark"] .kanban-filter-select option,
body:not([data-theme]) .kanban-filter-select option {
    background-color: #2d3748;
    color: #e2e8f0;
}

/* Filtros - Tema Claro */
[data-theme="light"] .kanban-filter-select {
    background-color: #f7fafc;
    color: #2d3748;
    border-color: #cbd5e0;
}

[data-theme="light"] .kanban-filter-select option {
    background-color: #ffffff;
    color: #2d3748;
}

/* Animações e efeitos */
.task-card-modern {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.task-card-modern:hover {
    transform: translateY(-2px);
}

[data-theme="dark"] .task-card-modern:hover,
body:not([data-theme]) .task-card-modern:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
}

[data-theme="light"] .task-card-modern:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}

/* Drag and drop */
.task-card-modern.dragging {
    opacity: 0.5;
}

.kanban-column.drag-over {
    background-color: rgba(101, 84, 192, 0.1);
    border: 2px dashed #6554c0;
    border-radius: 8px;
}
</style>
{% endblock %}
